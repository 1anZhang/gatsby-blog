---
title: reduxå¸¸ç”¨åº“
date: 2017-09-12 15:06:03
categories:
  - js
---

## 1. react-redux

Reactæ˜¯ä¸ªå®ç°ç•Œé¢çš„æ¡†æ¶ï¼Œreduxæ˜¯è¿›è¡ŒçŠ¶æ€ç®¡ç†çš„åº“ï¼Œä»–ä»¬ä¹‹é—´æ²¡æœ‰ä»»ä½•çš„å…³ç³»ï¼Œå¦‚æœæƒ³åŒæ—¶ä½¿ç”¨ä»–ä»¬ï¼Œæˆ‘ä»¬å°±è¿˜éœ€è¦ä½¿ç”¨react-reduxåº“æ¥è¿›è¡Œå…³è”ã€‚

### 1.1 å®¹å™¨ç»„ä»¶å’Œå±•ç¤ºç»„ä»¶

**ä»€ä¹ˆæ˜¯å®¹å™¨ç»„ä»¶å’Œå±•ç¤ºç»„ä»¶å‘¢ï¼Ÿ**

å®¹å™¨ç»„ä»¶æ˜¯å’Œreduxç›´æ¥å…³è”çš„å¤–å±‚ç»„ä»¶ï¼Œå®ƒéœ€è¦å¯¹æ•°æ®è¿›è¡Œå¤„ç†å’Œæ“ä½œï¼Œæ´¾å‘æ–°çš„actionï¼Œä¸æœåŠ¡å™¨äº¤äº’ç­‰åŠŸèƒ½ï¼Œåªå…³å¿ƒæ•°æ®å¤„ç†çš„é€»è¾‘ï¼Œå¹¶ä¸å…³å¿ƒæ•°æ®æ˜¯å¦‚ä½•å±•ç¤ºä»¥åŠé¡µé¢æ˜¯å¦‚ä½•å®ç°çš„ã€‚

å±•ç¤ºç»„ä»¶æ˜¯ç”¨æ¥å®ç°ç•Œé¢çš„ï¼Œå®ƒåªå…³æ³¨é¡µé¢çš„å¤–è§‚ã€å¦‚ä½•æ ¹æ®æ•°æ®ç”Ÿæˆé¡µé¢ä»¥åŠæ ¹æ®å®¹å™¨ç»„ä»¶æä¾›çš„æ–¹æ³•æ·»åŠ äº¤äº’äº‹ä»¶ï¼Œå¹¶ä¸å…³å¿ƒèƒŒåæ•°æ®å¤„ç†çš„é€»è¾‘ã€‚

|                |          å±•ç¤ºç»„ä»¶          |              å®¹å™¨ç»„ä»¶              |
| :------------: | :------------------------: | :--------------------------------: |
|      ä½œç”¨      | æè¿°å¦‚ä½•å±•ç°ï¼ˆéª¨æ¶ã€æ ·å¼ï¼‰ | æè¿°å¦‚ä½•è¿è¡Œï¼ˆæ•°æ®è·å–ã€çŠ¶æ€æ›´æ–°ï¼‰ |
| ç›´æ¥ä½¿ç”¨ Redux |             å¦             |                 æ˜¯                 |
|    æ•°æ®æ¥æº    |           props            |          ç›‘å¬ Redux state          |
|    æ•°æ®ä¿®æ”¹    |   ä» props è°ƒç”¨å›è°ƒå‡½æ•°    |       å‘ Redux æ´¾å‘ actions        |
|    è°ƒç”¨æ–¹å¼    |            æ‰‹åŠ¨            |      é€šå¸¸ç”± React Redux ç”Ÿæˆ       |

**è¿™æ ·æ¶æ„æœ‰ä»€ä¹ˆä¼˜ç‚¹å‘¢ï¼Ÿ**

- æ›´åŠ ä½çš„è€¦åˆæ€§ï¼Œåˆ†ç¦»æ€§æ›´å¥½ï¼Œåˆ†å·¥æ›´æ˜ç¡®ï¼Œé…åˆæ›´å®¹æ˜“ã€‚
- æ›´å¥½çš„å¤ç”¨æ€§ã€‚ä½ å¯ä»¥ç”¨åŒä¸€å¥—å®¹å™¨ç»„ä»¶è·å–æ•°æ®ï¼Œè€Œä½¿ç”¨ä¸åŒçš„å±•ç¤ºç»„ä»¶å»å±•ç¤ºï¼Œæ¯”å¦‚reactå®ç°webç«¯ï¼Œreact-nativeå®ç°æ‰‹æœºç«¯ï¼Œä»–ä»¬å¯ä»¥ä½¿ç”¨åŒä¸€å¥—å®¹å™¨ç»„ä»¶ã€‚ç›¸åä½ ä¹Ÿå¯ä»¥ç”¨åŒä¸€å¥—å±•ç¤ºç»„ä»¶å»å±•ç¤ºä¸åŒå®¹å™¨ç»„ä»¶çš„æ•°æ®ã€‚

### 1.2 Provider 

Providerä½œä¸ºæ•´ä¸ªåº”ç”¨æ•°æ®çš„è½½ä½“ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„ç”¨æ³•ï¼š

```javascript
ReactDOM.render(
  <Provider store={store}>
    <App />
  </Provider>,
  root
)
```

storeå°±æ˜¯reduxä¸­createStoreç”Ÿæˆçš„storeå¯¹è±¡ï¼Œä»–è¢«æ”¾è¿›äº†Providerçš„propsï¼Œå¹¶åœ¨åŒ…åœ¨äº†æ•´ä¸ªç¨‹åºçš„æœ€å¤–å±‚ã€‚è¿™æ ·æˆ‘ä»¬çš„åº”ç”¨å†…çš„ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è·å–åˆ°è¿™ä¸ªè¿™ä¸ªstoreå¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Œæˆ‘ä»¬é¦–å…ˆäº†è§£ä¸€ä¸‹reactä¸­çš„contextã€‚

#### 1.2.1 context

> **context**ï¼šContext provides a way to share values like these between components without having to explicitly pass a prop through every level of the tree.

 ç›¸å½“äºä¸€ä¸ªç¨‹åºä¸­çš„å…¨å±€å˜é‡ï¼Œæˆ‘ä»¬çŸ¥é“æ•°æ®åœ¨ç»„ä»¶é—´æ˜¯åªèƒ½ä»¥propsçš„æ–¹å¼å‘ä¸‹ä¼ é€’çš„ï¼Œå¦‚æœä¸€ä¸ªå˜é‡åœ¨ç»„ä»¶å†…å„ä¸ªå±‚çº§è¢«åå¤è°ƒç”¨ï¼Œä¼ é€’propsæ˜¯å¾ˆéº»çƒ¦çš„(cumbersome)ï¼Œæ­¤æ—¶ä½¿ç”¨contextæˆ‘ä»¬å°±å¯ä»¥åƒä½¿ç”¨å…¨å±€å˜é‡ä¸€æ ·åœ¨å†…éƒ¨ç›´æ¥è°ƒç”¨ï¼Œå½“ç„¶å…¨å±€å˜é‡ä¼šè®©å¼€å‘å˜å¾—æ›´åŠ éš¾ä»¥æ§åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åªåœ¨è¿™é‡Œä½¿ç”¨åˆ°å®ƒã€‚

#### 1.2.2 Provider.jsæºä»£ç 

```javascript
export function createProvider(storeKey = 'store') {
    const subscriptionKey = `${storeKey}Subscription`

    class Provider extends Component {
      	//åœ¨è¿™é‡Œå¾—åˆ°å­ç»„ä»¶çš„contextç¯å¢ƒï¼Œå¹¶æŠŠstoreè®¾ç½®ä¸ºå…¨å±€å˜é‡
        getChildContext() {
          return { [storeKey]: this[storeKey], [subscriptionKey]: null }
        }

        constructor(props, context) {
          super(props, context)
          //<Provider store={store}>
          this[storeKey] = props.store;
        }

        render() {
          return Children.only(this.props.children)
        }
    }

    if (process.env.NODE_ENV !== 'production') {
      Provider.prototype.componentDidUpdate = function () {
        if (this[storeKey] !== this.props.store) {
          warnAboutReceivingStore()
        }
      }
    }

    Provider.propTypes = {
        store: storeShape.isRequired,
        children: PropTypes.element.isRequired,
    }
  	//è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼Œä¸æ˜¾å¼æŒ‡å®šå…¨å±€å˜é‡çš„ç±»å‹ï¼Œåœ¨å­ç»„ä»¶ä¸­æ˜¯æ— æ³•è·å–åˆ°è¯¥å˜é‡çš„
    Provider.childContextTypes = {
        [storeKey]: storeShape.isRequired,
        [subscriptionKey]: subscriptionShape,
    }

    return Provider
}
```

Providerä½œä¸ºä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œæ¥æ”¶storeä½œä¸ºpropsï¼Œå¹¶ä¸”æŠŠstoreæ”¾åœ¨äº†contextä¸­ï¼ŒåŒ…è£¹åœ¨æ¥æ”¶åˆ°çš„ç»„ä»¶ä¸­ï¼Œä¸ºå­ç»„ä»¶æä¾›storeå¯¹è±¡ã€‚

### 1.3 Connect

Connectä¹Ÿæ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶,ä¸€å…±æ¥æ”¶4ä¸ªå‚æ•°ï¼š

- `mapStateToProps(state, [ownProps])` (*Function*): å¦‚æœå®šä¹‰è¯¥å‚æ•°ï¼Œç»„ä»¶å°†ä¼šç›‘å¬ Redux store çš„å˜åŒ–ã€‚ä»»ä½•æ—¶å€™ï¼Œåªè¦ Redux store å‘ç”Ÿæ”¹å˜ï¼Œ`mapStateToProps` å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚è¯¥å›è°ƒå‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ªçº¯å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šä¸ç»„ä»¶çš„ props åˆå¹¶ã€‚
- `mapDispatchToProps(dispatch, [ownProps]): dispatchProps`(*Object* or *Function*): å¦‚æœä¼ é€’çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆæ¯ä¸ªå®šä¹‰åœ¨è¯¥å¯¹è±¡çš„å‡½æ•°éƒ½å°†è¢«å½“ä½œ Redux action creatorï¼Œå¯¹è±¡æ‰€å®šä¹‰çš„æ–¹æ³•åå°†ä½œä¸ºå±æ€§åï¼›æ¯ä¸ªæ–¹æ³•å°†è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œå‡½æ•°ä¸­`dispatch`æ–¹æ³•ä¼šå°†action creatorçš„è¿”å›å€¼ä½œä¸ºå‚æ•°æ‰§è¡Œã€‚è¿™äº›å±æ€§ä¼šè¢«åˆå¹¶åˆ°ç»„ä»¶çš„ props ä¸­ã€‚
- [`mergeProps(stateProps, dispatchProps, ownProps): props`] (*Function*): å¦‚æœæŒ‡å®šäº†è¿™ä¸ªå‚æ•°ï¼Œ`mapStateToProps()` ä¸ `mapDispatchToProps()` çš„æ‰§è¡Œç»“æœå’Œç»„ä»¶è‡ªèº«çš„ `props` å°†ä¼ å…¥åˆ°è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­ã€‚è¯¥å›è°ƒå‡½æ•°è¿”å›çš„å¯¹è±¡å°†ä½œä¸º props ä¼ é€’åˆ°è¢«åŒ…è£…çš„ç»„ä»¶ä¸­ã€‚
- [`options`] *(Object)* å¦‚æœæŒ‡å®šè¿™ä¸ªå‚æ•°ï¼Œå¯ä»¥å®šåˆ¶ connector çš„è¡Œä¸ºã€‚
  - [`pure = true`] *(Boolean)*: å¦‚æœä¸º trueï¼Œconnector å°†æ‰§è¡Œ `shouldComponentUpdate` å¹¶ä¸”æµ…å¯¹æ¯” `mergeProps` çš„ç»“æœï¼Œé¿å…ä¸å¿…è¦çš„æ›´æ–°ã€‚
  - [`withRef = false`] *(Boolean)*: å¦‚æœä¸º trueï¼Œconnector ä¼šä¿å­˜ä¸€ä¸ªå¯¹è¢«è¢«åŒ…å«çš„ç»„ä»¶å®ä¾‹çš„å¼•ç”¨ï¼Œè¯¥å¼•ç”¨é€šè¿‡ `getWrappedInstance()` æ–¹æ³•è·å¾—ã€‚*é»˜è®¤å€¼ä¸º falseã€‚*

```javascript
connect([mapStateToProps], [mapDispatchToProps], [mergeProps], [options])
```

å¹³æ—¶æœ€å¸¸ç”¨çš„å°±æ˜¯å‰ä¸¤ä¸ªå‚æ•°ï¼Œå®ƒä¼šæŠŠæˆ‘ä»¬æ‰€éœ€è¦çš„stateå’Œdispatchä»storeé‡Œé¢æ‹¿å‡ºå¹¶ä½œä¸ºpropsä¼ é€’ç»™è¢«connectçš„å®¹å™¨ç»„ä»¶ã€‚è¿™æ ·å°±å¯ä»¥åœ¨å­ç»„ä»¶ä¸­å¾—åˆ°stateå¹¶ä¸”è¿›è¡Œç›¸å…³æ“ä½œäº†ã€‚

#### 1.3.1 connectæ ¸å¿ƒä»£ç 

connectçš„æºç è¿‡äºåºå¤§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåªæ”¾äº†ä¸€äº›æ ¸å¿ƒçš„ä»£ç 

```javascript
export default function connect(mapStateToProps, mapDispatchToProps, mergeProps, options = {}) {
  return function wrapWithConnect(WrappedComponent) {
    class Connect extends Component {
      constructor(props, context) {
        // Provideråœ¨æœ€å¤–å±‚ï¼Œä»Providerå¤„è·å¾—store
        this.store = props.store || context.store
        this.stateProps = computeStateProps(this.store, props)
        this.dispatchProps = computeDispatchProps(this.store, props)
        this.state = { storeState: null }
        // å¯¹statePropsã€dispatchPropsã€parentPropsè¿›è¡Œåˆå¹¶
        this.updateState()
      }
      shouldComponentUpdate(nextProps, nextState) {
        // è¿›è¡Œåˆ¤æ–­ï¼Œå½“æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼ŒComponenté‡æ–°æ¸²æŸ“
        if (propsChanged || mapStateProducedChange || dispatchPropsChanged) {
          this.updateState(nextProps)
            return true
          }
        }
        componentDidMount() {
          // æ”¹å˜Componentçš„state
          this.store.subscribe(() = {
            this.setState({
              storeState: this.store.getState()
            })
          })
        }
        render() {
          // ç”ŸæˆåŒ…è£¹ç»„ä»¶Connect
          return (
            <WrappedComponent {...this.nextState} />
          )
        }
      }
      Connect.contextTypes = {
        store: storeShape
      }
      return Connect;
    }
  }

```

æ•´ä¸ªConnectå†…éƒ¨çš„é€»è¾‘ä¸ºï¼š

- é€šè¿‡contextå¾—åˆ°Providerä¸­çš„storeå¯¹è±¡
- propsåŒ…æ‹¬statePropsã€dispatchPropsã€parentProps,åˆå¹¶åœ¨ä¸€èµ·å¾—åˆ°nextStateï¼Œä½œä¸ºpropsä¼ ç»™çœŸæ­£çš„Component
- componentDidMountæ—¶ï¼Œæ·»åŠ äº‹ä»¶this.store.subscribe(this.setState)ï¼Œå½“storeä¸­çš„æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¼šé‡æ–°è®¾ç½®stateï¼Œå¼•å‘æ­¤ç»„ä»¶çš„æ›´æ–°ï¼Œè€Œè¿™ä¸ªstateä½œä¸ºå­ç»„ä»¶çš„propsä¼šè§¦å‘å­ç»„ä»¶çš„æ›´æ–°
- shouldComponentUpdateæ—¶åˆ¤æ–­æ˜¯å¦æœ‰é¿å…è¿›è¡Œæ¸²æŸ“ï¼Œæå‡é¡µé¢æ€§èƒ½ï¼Œå¹¶å¾—åˆ°nextState

### 1.4 Model-->View

åœ¨reduxä¸­ï¼Œæˆ‘ä»¬çŸ¥é“äº†ä»Viewåˆ°Modelçš„æ•°æ®ä¼ é€’ï¼Œç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ä»Modelåˆ°Viewçš„æ•°æ®ä¼ é€’ã€‚

![](reduxå¸¸ç”¨åº“/connect.png)

é¦–å…ˆåœ¨connectä¸­è®¢é˜…storeï¼Œå½“storeå†…çš„stateå‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿå°±æ˜¯ä»»æ„ç»„ä»¶dispatch(action)å¹¶è¿›è¡Œäº†æ•°æ®æ›´æ–°ï¼Œæˆ‘ä»¬åœ¨connectæ–¹æ³•ä¸­å°±èƒ½å¾—åˆ°ä¸€ä»½æ›´æ–°åçš„storeï¼Œå½“æ•°æ®æ›´æ–°ä»¥åï¼Œæˆ‘ä»¬å°†æ–°çš„store.stateé€šè¿‡setStateçš„æ–¹æ³•ä¼ é€’ç»™connectç»„ä»¶ä½¿ç»„ä»¶å¾—åˆ°æ›´æ–°ï¼Œæ­¤æ—¶ä¼šè°ƒç”¨[mapStateToProps], [mapDispatchToProps],å¹¶ä¸”ä¸æœ¬èº«çš„onwPropsåˆå¹¶ï¼Œä»¥propsçš„æ–¹å¼ä¼ é€’ç»™å­ç»„ä»¶ï¼Œå­ç»„ä»¶åœ¨propså˜åŒ–åä¼šè§¦å‘è‡ªå·±ç›¸åº”çš„updateç”Ÿå‘½å‘¨æœŸä½¿é¡µé¢è¿›è¡Œåˆ·æ–°ã€‚

## 2. reselect

reselectåº“å¯ä»¥åˆ›å»ºå¯è®°å¿†çš„(Memoized)ã€å¯ç»„åˆçš„Â **selector**Â å‡½æ•°ã€‚Reselect selectors å¯ä»¥ç”¨æ¥é«˜æ•ˆåœ°è®¡ç®— Redux store é‡Œçš„è¡ç”Ÿæ•°æ®ã€‚

### 2.1 reselectç®€ä»‹

**ä¸ºä»€ä¹ˆéœ€è¦reselectï¼Ÿ**

å‡å¦‚æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªçŒªåœºğŸ–ï¼Œä»–çš„æ•°æ®å¦‚ä¸‹ï¼š

```js
Pigs = [{
          id: 0,
          weight: 60,
         },
         {
          id: 1,
          weight: 56,
         },
          ...
        ]
```

ç„¶åæˆ‘ä»¬æœ‰å¦å¤–ä¸€ä¸ªæ•°ç»„ç”¨æ¥å­˜æ”¾æ‰“ç®—å± å®°çš„ğŸ·çš„idï¼š

```js
killingPigs = [1, 3, 8, ...]
```

å¦‚æœä¸€æ–¤çŒªè‚‰20å—ï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³è¦çŸ¥é“å‡†å¤‡æ€æ‰çš„è¿™äº›ğŸ·ä¸€å…±èƒ½å–å¤šå°‘é’±ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦æ ¹æ®å·²æœ‰çš„æ•°æ®è®¡ç®—ï¼š

```js
//æ ¹æ®idæ‹¿åˆ°ğŸ·çš„é‡é‡æ•°æ®
const getWeight = (id) => Pigs.find((pig) => (pig.id === id)).weight
const money = killingPigs.reduce((acc, id) => (
  acc + getWeight(id) * 20
), 0)
```

è¿™æ ·æˆ‘ä»¬å°±çŸ¥é“è¿™äº›ğŸ·èƒ½å–å¤šå°‘é’±äº†ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜å‡ºç°äº†ï¼Œæˆ‘ä»¬æ¯æ¬¡æ“ä½œå¯¼è‡´é¡µé¢æ›´æ–°éƒ½ä¼šé‡æ–°è®¡ç®—è¿™ä¸ªä»·é’±ï¼Œå¦‚æœkillingPigsæ•°ç»„å¹¶æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆè‚¯å®šå–å‡ºçš„é’±ä¹Ÿæ˜¯ä¸å˜çš„ï¼Œåªæœ‰åœ¨killingPigsæ•°ç»„æ–°åŠ å…¥ğŸ·æˆ–è€…ç§»é™¤ğŸ·çš„æ—¶å€™ï¼Œç›¸åº”çš„ä»·æ ¼æ‰ä¼šæ”¹å˜ï¼Œå¦‚æœè¿™ä¸ªçŒªåœºæ˜¯ä¸€ä¸ªå¤§å‚ï¼Œæ¯”å¦‚ç½‘æ˜“ï¼Œé‚£ä¹ˆå¯èƒ½å°±æœ‰å‡ ä¸‡å‡ åä¸‡å¤´ï¼Œæ¯æ¬¡åˆ·æ–°éƒ½è®¡ç®—ä¸€ééå¸¸çš„è€—æ—¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥åªåœ¨killingPigsæ•°ç»„æ”¹å˜çš„æ—¶å€™æ‰è¿›è¡Œè®¡ç®—è€Œå…¶ä»–æ—¶å€™åªè¿”å›åŸæ¥ç®—å¥½çš„å€¼å‘¢ï¼Œæ˜¾ç„¶ï¼Œreselectå°±æ˜¯å¹²è¿™äº‹çš„ã€‚

é‚£ä¹ˆçœ‹ä¸€ä¸‹å®ƒçš„ä½¿ç”¨ï¼š

```js
//inputSelectorså¯ä»¥æ˜¯nä¸ªå‚æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ
//resultFuncæ ¹æ®inputSelectorsç»™å‡ºçš„å‚æ•°è¿›è¡Œç›¸åº”çš„è®¡ç®—å¹¶è¿”å›ç»“æœã€‚
createSelector(...inputSelectors | [inputSelectors], resultFunc)

//inputSelectorç›¸å½“äºä¸€ä¸ªè¿‡æ»¤å™¨ï¼ŒmySelector()çš„å‚æ•°å°±ä½œä¸ºå‚æ•°ä¼ å…¥inputSelectorå¹¶è¿›è¡Œè¿‡æ»¤
const getWeight = (id) => Pigs.find((pig) => (pig.id === id)).weight
const moneySelector = createSelector(
  killingPigs => killingPigs,
  (pigId) => {
    return pigId.reduce((acc, id) => (
      acc + getWeight(id) * 20
    ), 0)
  }
)
const money = moneySelector(killingPigs)
```

å› ä¸ºæˆ‘ä»¬çš„æ•°æ®ç»“æ„æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥åœ¨inputSelectoræ—¶ç›´æ¥è¾“å…¥åŸæ•°ç»„å³å¯ï¼Œæ³¨æ„ï¼Œselectorå¿…é¡»ä»¥å‡½æ•°çš„æ–¹å¼è¾“å…¥ï¼Œè¿™æ ·ä½¿ç”¨reselectè®¡ç®—çš„æ•°æ®ï¼Œåœ¨æˆ‘ä»¬çš„è¾“å…¥å‚æ•°killingPigsä¸æ”¹å˜çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸ä¼šé‡æ–°è®¡ç®—çš„ï¼Œä¼šå¯¹è®¡ç®—ç»“æœæœ‰ä¸€ä¸ªç¼“å­˜ï¼Œå¤§å¤§åŠ å¿«äº†ç¨‹åºçš„è¿è¡Œã€‚

### 2.2 reselectæºä»£ç 

```js
//è¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥è¿›è¡Œå‚æ•°æ¯”è¾ƒçš„ï¼Œ 
function defaultEqualityCheck(a, b) {
  return a === b
}

function areArgumentsShallowlyEqual(equalityCheck, prev, next) {
  if (prev === null || next === null || prev.length !== next.length) {
    return false
  }

  // Do this in a for loop (and not a `forEach` or an `every`) so we can determine equality as fast as possible.
  const length = prev.length
  for (let i = 0; i < length; i++) {
    if (!equalityCheck(prev[i], next[i])) {
      return false
    }
  }

  return true
}

export function defaultMemoize(func, equalityCheck = defaultEqualityCheck) {
  let lastArgs = null
  let lastResult = null
  // we reference arguments instead of spreading them for performance reasons
  return function () {
    if (!areArgumentsShallowlyEqual(equalityCheck, lastArgs, arguments)) {
      // apply arguments instead of spreading for performance.
      lastResult = func.apply(null, arguments)
    }

    lastArgs = arguments
    return lastResult
  }
}

function getDependencies(funcs) {
  const dependencies = Array.isArray(funcs[0]) ? funcs[0] : funcs

  if (!dependencies.every(dep => typeof dep === 'function')) {
    const dependencyTypes = dependencies.map(
      dep => typeof dep
    ).join(', ')
    throw new Error(
      'Selector creators expect all input-selectors to be functions, ' +
      `instead received the following types: [${dependencyTypes}]`
    )
  }

  return dependencies
}

export function createSelectorCreator(memoize, ...memoizeOptions) {
  return (...funcs) => {
    let recomputations = 0
    const resultFunc = funcs.pop()
    const dependencies = getDependencies(funcs)

    const memoizedResultFunc = memoize(
      function () {
        recomputations++
        // apply arguments instead of spreading for performance.
        return resultFunc.apply(null, arguments)
      },
      ...memoizeOptions
    )

    // If a selector is called with the exact same arguments we don't need to traverse our dependencies again.
    const selector = memoize(function () {
      const params = []
      const length = dependencies.length

      for (let i = 0; i < length; i++) {
        // apply arguments instead of spreading and mutate a local list of params for performance.
        params.push(dependencies[i].apply(null, arguments))
      }

      // apply arguments instead of spreading for performance.
      return memoizedResultFunc.apply(null, params)
    })

    selector.resultFunc = resultFunc
    selector.dependencies = dependencies
    selector.recomputations = () => recomputations
    selector.resetRecomputations = () => recomputations = 0
    return selector
  }
}

export const createSelector = createSelectorCreator(defaultMemoize)

export function createStructuredSelector(selectors, selectorCreator = createSelector) {
  if (typeof selectors !== 'object') {
    throw new Error(
      'createStructuredSelector expects first argument to be an object ' +
      `where each property is a selector, instead received a ${typeof selectors}`
    )
  }
  const objectKeys = Object.keys(selectors)
  return selectorCreator(
    objectKeys.map(key => selectors[key]),
    (...values) => {
      return values.reduce((composition, value, index) => {
        composition[objectKeys[index]] = value
        return composition
      }, {})
    }
  )
}
```



## 3. immutable

### 3.1 ä»€ä¹ˆæ˜¯immutability

immutabilityè¡¨ç¤ºç»è¿‡ä¸€äº›å¤„ç†åï¼Œå˜é‡çš„å€¼æˆ–è€…çŠ¶æ€ä»»ç„¶ä¿æŒä¸å˜ã€‚

ä½ å¯ä»¥åœ¨ JavaScript è¯­è¨€æœ¬èº«ä¸­æ‰¾åˆ° immutable ç±»å‹ã€‚`String` å¯¹è±¡çš„**å€¼ç±»å‹**å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚

å¦‚æœä½ å£°æ˜ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ï¼Œå¦‚ä¸‹ï¼š

```js
var str = 'abc';
```

ä½ æ— æ³•ç›´æ¥ä¿®æ”¹å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ã€‚

åœ¨ JavaScript ä¸­ï¼Œå­—ç¬¦ä¸²ç±»å‹çš„å€¼ä¸æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ä½ ä¸èƒ½åƒä¸‹é¢è¿™æ ·åšï¼š

```js
str[2] = 'd';
```

å¯ä»¥è¯•è¯•è¿™æ ·ï¼š

```js
str = 'abd';
```

å°†å¦ä¸€ä¸ªå­—ç¬¦ä¸²èµ‹å€¼ç»™ `str`ã€‚

ä½ ç”šè‡³å¯ä»¥å°† `str` é‡æ–°å£°æ˜ä¸ºä¸€ä¸ªå¸¸é‡ï¼š

```js
const str = 'abc'
```

ç»“æœï¼Œé‡æ–°å£°æ˜ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼ˆä½†æ˜¯è¿™ä¸ªé”™è¯¯å’Œ immutability æ— å…³ï¼‰ã€‚

å¦‚æœä½ æƒ³ä¿®æ”¹å­—ç¬¦ä¸²çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æ–¹æ³•ï¼Œä¾‹å¦‚ï¼šreplaceã€toUpperCaseæˆ– trimã€‚

æ‰€æœ‰è¿™äº›æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œè€Œä¸ä¼šæ”¹å˜åŸå­—ç¬¦ä¸²çš„å€¼ã€‚

### 3.2 å¼•ç”¨ç›¸ç­‰ vs å€¼ç›¸ç­‰

å¼•ç”¨ç›¸ç­‰ï¼Œä½ é€šè¿‡ `===` å’Œ `!==` (æˆ–è€… `==` å’Œ `!=`) æ“ä½œç¬¦æ¯”è¾ƒå¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æœå¼•ç”¨æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä»–ä»¬å°±æ˜¯ç›¸ç­‰çš„ï¼š

```js
var str1 = â€˜abcâ€™;
var str2 = str1;

str1 === str2 // true
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä¸¤ä¸ªå¼•ç”¨ï¼ˆ`str1` å’Œ `str2`ï¼‰éƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼ˆ`'abc'`ï¼‰ï¼Œæ‰€ä»¥ä»–ä»¬æ˜¯ç›¸ç­‰çš„ã€‚

![](reduxå¸¸ç”¨åº“/pic1.png)

å¦‚æœä¸¤ä¸ªå¼•ç”¨éƒ½æŒ‡å‘ä¸€ä¸ª immutable çš„å€¼ï¼Œä»–ä»¬ä¹Ÿæ˜¯ç›¸ç­‰çš„ï¼Œå¦‚ä¸‹ï¼š

```js
var str1 = â€˜abcâ€™;
var str2 = â€˜abcâ€™;

str1 === str2 // true

var n1 = 1;
var n2 = 1;

n1 === n2 // also true
```

![](reduxå¸¸ç”¨åº“/pic2.png)

ä½†å¦‚æœæŒ‡å‘çš„æ˜¯å¯¹è±¡ï¼Œé‚£å°±ä¸å†ç›¸ç­‰äº†ï¼š

```js
var str1 =  new String(â€˜abcâ€™);
var str2 = new String(â€˜abcâ€™);

str1 === str2 // false

var arr1 = [];
var arr2 = [];

arr1 === arr2 // false
```

ä¸Šé¢çš„ä¸¤ç§æƒ…å†µï¼Œéƒ½ä¼šåˆ›å»ºä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œæ‰€ä»¥ä»–ä»¬çš„å¼•ç”¨ä¸ç›¸ç­‰ï¼š

![](reduxå¸¸ç”¨åº“/pic3.png)

å¦‚æœä½ æƒ³æ£€æŸ¥ä¸¤ä¸ªå¯¹è±¡çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œä½ éœ€è¦æ¯”è¾ƒä»–ä»¬çš„å€¼å±æ€§ã€‚

åœ¨ JavaScript ä¸­ï¼Œæ²¡æœ‰ç›´æ¥æ¯”è¾ƒæ•°ç»„å’Œå¯¹è±¡å€¼çš„æ–¹æ³•ã€‚

å¦‚æœä½ è¦æ¯”è¾ƒå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨è¿”å›æ–°å­—ç¬¦ä¸²çš„ `valueOf` æˆ– `trim` æ–¹æ³•ï¼š

```js
var str1 =  new String(â€˜abcâ€™);
var str2 = new String(â€˜abcâ€™);

str1.valueOf() === str2.valueOf() // true
str1.trim() === str2.trim() // true
```

ä½†å¯¹äºå…¶ä»–ç±»å‹çš„å¯¹è±¡ï¼Œä½ åªèƒ½å®ç°è‡ªå·±çš„æ¯”è¾ƒæ–¹æ³•æˆ–è€…ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå¯ä»¥å‚è€ƒ [è¿™ç¯‡æ–‡ç« ](http://adripofjavascript.com/blog/drips/object-equality-in-javascript.html)ã€‚

ä½†è¿™å’Œ immutability å’Œ React æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ

å¦‚æœä¸¤ä¸ªå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œé‚£ä¹ˆæ¯”è¾ƒä»–ä»¬æ˜¯å¦ç›¸ç­‰æ¯”è¾ƒå®¹æ˜“ã€‚React å°±æ˜¯åˆ©ç”¨äº†è¿™ä¸ªæ¦‚å¿µæ¥è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„ã€‚

æˆ‘ä»¬æ¥å…·ä½“è°ˆè°ˆå§ã€‚

### 3.3 React ä¸­çš„æ€§èƒ½ä¼˜åŒ–

React å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä»½ UI è¡¨è¿°ï¼Œå°±æ˜¯ [è™šæ‹Ÿ DOM](http://reactkungfu.com/2015/10/the-difference-between-virtual-dom-and-dom/)ã€‚

å¦‚æœä¸€ä¸ªç»„ä»¶çš„å±æ€§å’ŒçŠ¶æ€æ”¹å˜äº†ï¼Œä»–å¯¹åº”çš„è™šæ‹Ÿ DOM æ•°æ®ä¹Ÿä¼šæ›´æ–°è¿™äº›å˜åŒ–ã€‚å› ä¸ºä¸ç”¨ä¿®æ”¹çœŸå®é¡µé¢ï¼Œæ“ä½œè™šæ‹Ÿ DOM æ›´åŠ æ–¹ä¾¿å¿«æ·ã€‚

ç„¶åï¼ŒReact ä¼šå¯¹ç°åœ¨å’Œæ›´æ–°å‰ç‰ˆæœ¬çš„è™šæ‹Ÿ DOM è¿›è¡Œæ¯”è¾ƒï¼Œæ¥æ‰¾å‡ºå“ªäº›æ”¹å˜äº†ã€‚æ¯”è¾ƒç®—æ³•æ˜¯diffç®—æ³•ã€‚è¿™æ ·ï¼Œå°±åªæœ‰æœ‰å˜åŒ–çš„å…ƒç´ ä¼šåœ¨çœŸå® DOM ä¸­æ›´æ–°ã€‚

#### 3.3.1 Reactä¸­çš„diffç®—æ³•

 **tree diff**

åŸºäºç­–ç•¥ä¸€ï¼ŒReact å¯¹æ ‘çš„ç®—æ³•è¿›è¡Œäº†ç®€æ´æ˜äº†çš„ä¼˜åŒ–ï¼Œå³å¯¹æ ‘è¿›è¡Œåˆ†å±‚æ¯”è¾ƒï¼Œä¸¤æ£µæ ‘åªä¼šå¯¹åŒä¸€å±‚æ¬¡çš„èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚

æ—¢ç„¶ DOM èŠ‚ç‚¹è·¨å±‚çº§çš„ç§»åŠ¨æ“ä½œå°‘åˆ°å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œé’ˆå¯¹è¿™ä¸€ç°è±¡ï¼ŒReact é€šè¿‡ updateDepth å¯¹ Virtual DOM æ ‘è¿›è¡Œå±‚çº§æ§åˆ¶ï¼Œåªä¼šå¯¹ç›¸åŒé¢œè‰²æ–¹æ¡†å†…çš„ DOM èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œå³åŒä¸€ä¸ªçˆ¶èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ã€‚å½“å‘ç°èŠ‚ç‚¹å·²ç»ä¸å­˜åœ¨ï¼Œåˆ™è¯¥èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹ä¼šè¢«å®Œå…¨åˆ é™¤æ‰ï¼Œä¸ä¼šç”¨äºè¿›ä¸€æ­¥çš„æ¯”è¾ƒã€‚è¿™æ ·åªéœ€è¦å¯¹æ ‘è¿›è¡Œä¸€æ¬¡éå†ï¼Œä¾¿èƒ½å®Œæˆæ•´ä¸ª DOM æ ‘çš„æ¯”è¾ƒã€‚

![](reduxå¸¸ç”¨åº“/diff1.jpg)

**component diff**

React æ˜¯åŸºäºç»„ä»¶æ„å»ºåº”ç”¨çš„ï¼Œå¯¹äºç»„ä»¶é—´çš„æ¯”è¾ƒæ‰€é‡‡å–çš„ç­–ç•¥ä¹Ÿæ˜¯ç®€æ´é«˜æ•ˆã€‚

- å¦‚æœæ˜¯åŒä¸€ç±»å‹çš„ç»„ä»¶ï¼ŒæŒ‰ç…§åŸç­–ç•¥ç»§ç»­æ¯”è¾ƒ virtual DOM treeã€‚
- å¦‚æœä¸æ˜¯ï¼Œåˆ™å°†è¯¥ç»„ä»¶åˆ¤æ–­ä¸º dirty componentï¼Œä»è€Œæ›¿æ¢æ•´ä¸ªç»„ä»¶ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ã€‚
- å¯¹äºåŒä¸€ç±»å‹çš„ç»„ä»¶ï¼Œæœ‰å¯èƒ½å…¶ Virtual DOM æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œå¦‚æœèƒ½å¤Ÿç¡®åˆ‡çš„çŸ¥é“è¿™ç‚¹é‚£å¯ä»¥èŠ‚çœå¤§é‡çš„ diff è¿ç®—æ—¶é—´ï¼Œå› æ­¤ React å…è®¸ç”¨æˆ·é€šè¿‡ shouldComponentUpdate() æ¥åˆ¤æ–­è¯¥ç»„ä»¶æ˜¯å¦éœ€è¦è¿›è¡Œ diffã€‚

**element diff**

å¦‚ä¸‹å›¾ï¼Œè€é›†åˆä¸­åŒ…å«èŠ‚ç‚¹ï¼šAã€Bã€Cã€Dï¼Œæ›´æ–°åçš„æ–°é›†åˆä¸­åŒ…å«èŠ‚ç‚¹ï¼šBã€Aã€Dã€Cï¼Œæ­¤æ—¶æ–°è€é›†åˆè¿›è¡Œ diff å·®å¼‚åŒ–å¯¹æ¯”ï¼Œå‘ç° B != Aï¼Œåˆ™åˆ›å»ºå¹¶æ’å…¥ B è‡³æ–°é›†åˆï¼Œåˆ é™¤è€é›†åˆ Aï¼›ä»¥æ­¤ç±»æ¨ï¼Œåˆ›å»ºå¹¶æ’å…¥ Aã€D å’Œ Cï¼Œåˆ é™¤ Bã€C å’Œ Dã€‚

![](reduxå¸¸ç”¨åº“/diff2.jpg)

React å‘ç°è¿™ç±»æ“ä½œç¹çå†—ä½™ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯ç›¸åŒçš„èŠ‚ç‚¹ï¼Œä½†ç”±äºä½ç½®å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´éœ€è¦è¿›è¡Œç¹æ‚ä½æ•ˆçš„åˆ é™¤ã€åˆ›å»ºæ“ä½œï¼Œå…¶å®åªè¦å¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œä½ç½®ç§»åŠ¨å³å¯ã€‚

é’ˆå¯¹è¿™ä¸€ç°è±¡ï¼ŒReact æå‡ºä¼˜åŒ–ç­–ç•¥ï¼šå…è®¸å¼€å‘è€…å¯¹åŒä¸€å±‚çº§çš„åŒç»„å­èŠ‚ç‚¹ï¼Œæ·»åŠ å”¯ä¸€ key è¿›è¡ŒåŒºåˆ†ï¼Œè™½ç„¶åªæ˜¯å°å°çš„æ”¹åŠ¨ï¼Œæ€§èƒ½ä¸Šå´å‘ç”Ÿäº†ç¿»å¤©è¦†åœ°çš„å˜åŒ–ï¼

æ–°è€é›†åˆæ‰€åŒ…å«çš„èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ–°è€é›†åˆè¿›è¡Œ diff å·®å¼‚åŒ–å¯¹æ¯”ï¼Œé€šè¿‡ key å‘ç°æ–°è€é›†åˆä¸­çš„èŠ‚ç‚¹éƒ½æ˜¯ç›¸åŒçš„èŠ‚ç‚¹ï¼Œå› æ­¤æ— éœ€è¿›è¡ŒèŠ‚ç‚¹åˆ é™¤å’Œåˆ›å»ºï¼Œåªéœ€è¦å°†è€é›†åˆä¸­èŠ‚ç‚¹çš„ä½ç½®è¿›è¡Œç§»åŠ¨ï¼Œæ›´æ–°ä¸ºæ–°é›†åˆä¸­èŠ‚ç‚¹çš„ä½ç½®ï¼Œæ­¤æ—¶ React ç»™å‡ºçš„ diff ç»“æœä¸ºï¼šBã€D ä¸åšä»»ä½•æ“ä½œï¼ŒAã€C è¿›è¡Œç§»åŠ¨æ“ä½œï¼Œå³å¯ã€‚

![](reduxå¸¸ç”¨åº“/diff3.jpg)

ä»¥ä¸Šæ˜¯reactè‡ªå¸¦çš„å†…éƒ¨æ¸²æŸ“ä¼˜åŒ–ï¼Œæœ‰æ—¶ï¼Œä¸€äº› DOM å…ƒç´ è‡ªèº«æ²¡å˜åŒ–ï¼Œä½†ä¼šè¢«å…¶ä»–å…ƒç´ å½±å“ï¼Œé€ æˆé‡æ–°æ¸²æŸ“ã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥é€šè¿‡shouldComponentUpdateæ–¹æ³•æ¥åˆ¤æ–­å±æ€§å’Œæ–¹æ³•æ˜¯ä¸æ˜¯çœŸçš„æ”¹å˜äº†ï¼Œæ˜¯å¦è¿”å› true æ¥æ›´æ–°è¿™ä¸ªç»„ä»¶ï¼š

```js
class MyComponent extends Component {

  // ...

  shouldComponentUpdate(nextProps, nextState) {
    if (this.props.someProps !== nextProps.someProps) {
      return true;
    }
    return false;
  }

  // ...
}
```

 å¦‚æœç»„ä»¶çš„å±æ€§å’ŒçŠ¶æ€æ˜¯ immutable çš„å¯¹è±¡æˆ–å€¼ï¼Œä½ å¯ä»¥é€šè¿‡ç›¸ç­‰æ¯”è¾ƒåˆ¤æ–­ä»–ä»¬æ˜¯å¦æ”¹å˜äº†ã€‚å› ä¸ºï¼Œæ¯”è¾ƒçš„å¯¹è±¡å¯èƒ½å­˜åœ¨å¾ˆæ·±çš„åµŒå¥—ï¼Œæ¯”å¦‚ï¼š

```js
myPackage.sender.address.country.id = 1;
```

æˆ‘ä»¬æƒ³è¦æ¯”è¾ƒè¿™ä¸¤ä¸ªå¯¹è±¡ï¼Œåªèƒ½ä¸€å±‚ä¸€å±‚çš„éå†å’Œæ¯”è¾ƒï¼Œå¯¹äºå¤§å‹æ•°æ®ç»“æ„ï¼Œè¿™ç§æ¯”è¾ƒæ˜¾ç„¶æ˜¯ä¸å¯è¡Œçš„ï¼Œæ­¤æ—¶ï¼Œä½¿ç”¨immutableå¯¹è±¡ï¼Œå¯ä»¥å¾ˆå¥½çš„å‘æŒ¥å®ƒçš„ä¼˜åŠ¿ï¼Œé¦–å…ˆï¼Œimmutableçš„å¯¹è±¡å¦‚æœå€¼å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸€å®šæ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡è€Œä¸ä¼šä¿®æ”¹åŸæ¥çš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒæœ€å¤–å±‚çš„å¼•ç”¨æ¥ç›´æ¥åˆ¤å®šä¸€ä¸ªå¯¹è±¡æœ‰æ²¡æœ‰è¿›è¡Œè¿‡ä¿®æ”¹ï¼Œå¼•ç”¨ä¸ä¸€æ ·æ—¶æˆ‘ä»¬å°±å¯ä»¥é‡æ–°è¿›è¡Œæ¸²æŸ“æ¥æ›´æ–°é¡µé¢ã€‚

###  3.4 æ•°æ®æŒä¹…åŒ–å’Œç»“æ„å…±äº«

> [Persistent data structures](https://en.wikipedia.org/wiki/Persistent_data_structure)Â enforces a constraint that all operations will return a newer version of that data structure and keep the original structure intact, instead of updating the original structure in-place.

 æŒä¹…åŒ–çš„æ•°æ®ç»“æ„ä¼šå¼ºåˆ¶æ‰€æœ‰å¯¹æ•°æ®çš„æ“ä½œéƒ½è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€Œä¸å»ä¿®æ”¹åŸæ¥çš„ä»»ä½•æ•°æ®ï¼Œä¿è¯åŸæ¥çš„æ•°æ®ä¸è¢«æ›´æ”¹ã€‚

#### 3.4.1 Trie

é¦–å…ˆæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯trieï¼Œå‡è®¾æˆ‘ä»¬è¦å­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹ï¼š

![img](reduxå¸¸ç”¨åº“/trie1.png)

æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬ç›´æ¥å­˜åˆ°ä¸€ä¸ªJavaScriptå¯¹è±¡ä¸­ï¼š

```
const data = {
  to: 7,
  tea: 3,
  ted: 4,
  ten: 12,
  A: 15,
  i: 11,
  in: 5,
  inn: 9
}
```

ä½†æ˜¯æˆ‘ä»¬åº”è¯¥å¦‚æœä½¿ç”¨[trie](https://en.wikipedia.org/wiki/Trie)ç»“æ„æ¥å­˜å‚¨å®ƒå‘¢? Trieçš„æ•°æ®ç»“æ„æœ‰ä¸€äº›åƒTreeï¼Œå¦‚ä¸‹å›¾ï¼š

![img](reduxå¸¸ç”¨åº“/trie2.png)

é€šå¸¸ï¼Œä½ å¯ä»¥ä»æ ¹èŠ‚ç‚¹é¡ºç€è·¯å¾„æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„å€¼ï¼Œæ¯”å¦‚ä½ æƒ³æŸ¥æ‰¾`data.in`ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œé¡ºç€iå’Œnï¼Œä½ å°±å¯ä»¥æŸ¥æ‰¾åˆ°inçš„å€¼ä¸º5ã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•ä¿®æ”¹å®ƒçš„å€¼å‘¢ï¼Ÿç°åœ¨æˆ‘ä»¬è¦ä¿®æ”¹teaçš„å€¼ï¼ŒæŠŠå®ƒçš„å€¼ä»3æ”¹ä¸º14.æˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªæ–°çš„trieï¼Œå°½å¯èƒ½å¤ç”¨å·²ç»å­˜åœ¨çš„èŠ‚ç‚¹ã€‚

![img](reduxå¸¸ç”¨åº“/trie3.png)

åŸæ¥çš„æ ‘è¿˜åœ¨ï¼Œæ²¡æœ‰å¯¹å®ƒè¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œæ­¤æ—¶ä½ å¯ä»¥é€šè¿‡new rootè·å¾—ä¿®æ”¹åçš„trieã€‚

![img](reduxå¸¸ç”¨åº“/trie4.png)

å¦‚æœold rootä¸å†è¢«å¼•ç”¨ï¼Œç°è‰²èŠ‚ç‚¹å°±ä¼šè¢«åƒåœ¾æ”¶é›†æœºåˆ¶ç»™å›æ”¶ã€‚

è¿™æ ·æˆ‘ä»¬åªéœ€è¦åˆ›å»º4ä¸ªæ–°çš„èŠ‚ç‚¹å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ ‘ï¼Œå‰©ä¸‹çš„èŠ‚ç‚¹æˆ‘ä»¬éƒ½ç›´æ¥æ‹¿æ¥å¤ç”¨äº†ï¼Œå¤§å¤§æé«˜äº†æ•ˆç‡ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º**ç»“æ„å…±äº«(structural sharing)**ã€‚

 `Immutable.Map`çš„å®ç°ï¼šå®ƒæœ€å¤šå¯ä»¥å­˜åœ¨2çš„5æ¬¡æ–¹ï¼Œå³32ä¸ªåˆ†æ”¯ã€‚

![img](reduxå¸¸ç”¨åº“/trie5.png)

æ˜¾ç„¶ï¼Œå½“æˆ‘ä»¬åªæ˜¯ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåªæœ‰è¯¥èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹è·¯å¾„ä¸Šçš„èŠ‚ç‚¹éœ€è¦æ›´æ–°ï¼Œå…¶ä»–èŠ‚ç‚¹ç›´æ¥æ‹¿æ¥å¤ç”¨å³å¯ã€‚

Immutable.jsä½¿ç”¨ [crazy advanced techniques](http://www.slideshare.net/mohitthatte/a-deep-dive-into-clojures-data-structures-euroclojure-2015) æ¥ä¿æŒæ ‘çš„ç»“æ„ç´§å‡‘å¹¶ä¸”ä½¿ç”¨ [creating multiple types of nodes](https://github.com/facebook/immutable-js/blob/0155f1c7b2e9c575b2090ff0e5e9093ae1039c87/src/Map.js#L223-L532) æ¥å¤„ç†å„ç§å„æ ·çš„å­æ ‘ã€‚

![img](reduxå¸¸ç”¨åº“/trie6.png)



## 4.redux-thunk

redux-thunkæ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†å¼‚æ­¥actionçš„ä¸­é—´ä»¶ï¼Œä¸ºä»€ä¹ˆè¦å¤„ç†å¼‚æ­¥actionå‘¢ï¼Œå› ä¸ºå½“æˆ‘ä»¬è¿›è¡ŒæœåŠ¡å™¨è¯·æ±‚ç­‰å¼‚æ­¥æ“ä½œæ—¶ï¼Œéœ€è¦ç­‰å¾…æ•°æ®è¿”å›æ‰èƒ½ç»§ç»­è¿›è¡Œæ¥ä¸‹æ¥çš„æ“ä½œã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªç®€å•çš„å¼‚æ­¥actionï¼š

```js
export const pickApples = () => {
  return (dispatch) => {
    dispatch(pickApplesStart())
    axios.put(`${HOST}/apple/pick`)
      .then(function(res){
          dispatch(pickApplesSuccess(res))
       })
      .catch(function(error){
           dispatch(pickApplesFailure(error))
       })
    }
}
```

è¿™ä¸ªå¼‚æ­¥actionå®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒéœ€è¦æ‰§è¡Œajaxè¯·æ±‚æ¥ä»æœåŠ¡å™¨è·å–æ•°æ®ï¼Œå¹¶ä¸”æ ¹æ®æ•°æ®çš„è¿”å›çŠ¶æ€æ¥æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œè€Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªæ™®é€šçš„actionæ˜¯ä¸€ä¸ªjså¯¹è±¡ï¼Œreducerä¹Ÿåªèƒ½æ¥æ”¶jså¯¹è±¡ä½œä¸ºå‚æ•°å»ä¿®æ”¹stateã€‚

æ­¤æ—¶å°±éœ€è¦thunkä¸­é—´ä»¶æ¥å¯¹actionè¿›è¡Œå¤„ç†ï¼Œå®ƒå¿…é¡»æ”¾åœ¨middlewareæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œå› ä¸ºåé¢çš„ä¸­é—´ä»¶æ‰€èƒ½æ¥æ”¶çš„å‚æ•°éƒ½æ˜¯ä¸€ä¸ªæ™®é€šçš„actionå¯¹è±¡ã€‚

```js
function createThunkMiddleware(extraArgument) {

  return ({ dispatch, getState }) => next => action => {

    if (typeof action === 'function') {
       return action(dispatch, getState, extraArgument);
    }

    return next(action);
  };
}
```

thunkçš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå½“ä¼ å…¥çš„actionæ˜¯ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå°±è®¤ä¸ºä»–æ˜¯å¼‚æ­¥actionï¼Œä¼ å…¥å‚æ•°ç»™å®ƒè®©ä»–æ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œå¦‚æœä¼ å…¥çš„actionæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšå‘åä¼ é€’ã€‚è¿™æ ·å°±è§£å†³äº†å¼‚æ­¥è¯·æ±‚çš„é—®é¢˜ã€‚

## 5. å‚è€ƒå†…å®¹

[connectåŸç†è§£æ](https://www.jianshu.com/p/9873d4ccb891)

[contextå®˜æ–¹æ–‡æ¡£](https://reactjs.org/docs/context.html)

[react-reduxæ–‡æ¡£](https://cn.redux.js.org/docs/react-redux/)

[react-reduxæºä»£ç ](https://github.com/reduxjs/react-redux)

[reselect github](https://github.com/reduxjs/reselect)

[react diffæºç è§£æç³»åˆ—](https://zhuanlan.zhihu.com/p/20346379)

[immutableè§£æ](https://blog.logrocket.com/immutability-in-react-ebe55253a1cc)

[Immutable.js, persistent data structures and structural sharing](https://medium.com/@dtinth/immutable-js-persistent-data-structures-and-structural-sharing-6d163fbd73d2)